/** * Invoicex * Copyright (c) 2005,2006,2007 Marco Ceccarelli, Tnx snc * * Questo software è soggetto, e deve essere distribuito con la licenza   * GNU General Public License, Version 2. La licenza accompagna il software * o potete trovarne una copia alla Free Software Foundation http://www.fsf.org . * * This software is subject to, and may be distributed under, the * GNU General Public License, Version 2. The license should have * accompanied the software or you may obtain a copy of the license * from the Free Software Foundation at http://www.fsf.org . *  * -- * Marco Ceccarelli (m.ceccarelli@tnx.it) * Tnx snc (http://www.tnx.it) * */package gestioneFatture;import gestioneFatture.logic.provvigioni.ProvvigioniFattura;import it.tnx.Db;import it.tnx.commons.CastUtils;import it.tnx.commons.DbUtils;import it.tnx.commons.FormatUtils;import it.tnx.commons.SwingUtils;import it.tnx.invoicex.InvoicexUtil;import java.sql.Connection;import java.sql.ResultSet;import java.sql.Types;import java.util.Calendar;import java.util.Date;import java.util.GregorianCalendar;import java.util.Vector;import javax.swing.JInternalFrame;public class Scadenze {    public String documento_tipo;    public String documento_serie;    public int documento_numero;    public int documento_anno;    public Date documento_data;    private String pagamento_tipo;    private boolean flag_pagata;    private double documento_importo;    private double documento_imponibile;    private double documento_iva;    private double totale_scadenze;    private int numero; //per calcolare il progressivo delle scadenze    double quadratura = 0;    java.text.SimpleDateFormat dateFormat = new java.text.SimpleDateFormat("dd/MM/yy");    Connection conn = null;    /** Creates a new instance of Scadenze */    public Scadenze(String documento_tipo, String documento_serie, int documento_numero, int documento_anno, String pagamento_tipo) {        this(null, documento_tipo, documento_serie, documento_numero, documento_anno, pagamento_tipo, null);    }    public Scadenze(Connection conn, String documento_tipo, String documento_serie, int documento_numero, int documento_anno, String pagamento_tipo) {        this(conn, documento_tipo, documento_serie, documento_numero, documento_anno, pagamento_tipo, null);    }    public Scadenze(String documento_tipo, String documento_serie, int documento_numero, int documento_anno, String pagamento_tipo, Date documento_data) {        this(null, documento_tipo, documento_serie, documento_numero, documento_anno, pagamento_tipo, documento_data);    }    public Scadenze(Connection conn, String documento_tipo, String documento_serie, int documento_numero, int documento_anno, String pagamento_tipo, Date documento_data) {        this.conn = conn;        String sql;        this.documento_tipo = documento_tipo;        this.documento_serie = documento_serie;        this.documento_numero = documento_numero;        this.documento_anno = documento_anno;        this.pagamento_tipo = pagamento_tipo;        this.documento_data = documento_data;        sql = "";        if (pagamento_tipo == null) {            if (documento_tipo.equals(Db.TIPO_DOCUMENTO_DDT)) {                sql = "Select pagamento from test_ddt";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                sql = "Select pagamento from test_fatt";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA_RICEVUTA)) {                sql = "Select pagamento from test_fatt_acquisto";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE)) {                sql = "Select pagamento from test_ordi";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE_ACQUISTO)) {                sql = "Select pagamento from test_ordi_acquisto";            }            sql += " where serie = " + Db.pc(documento_serie, Types.VARCHAR);            sql += " and numero = " + Db.pc(documento_numero, Types.INTEGER);            sql += " and anno = " + Db.pc(documento_anno, Types.INTEGER);            if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                sql += " and IFNULL(tipo_fattura,0) != 7";            }            ResultSet tempDocuPagamento = Db.openResultSet(conn, sql);            try {                tempDocuPagamento.next();                pagamento_tipo = tempDocuPagamento.getString(1);            } catch (Exception err) {                err.printStackTrace();            }        }        if (pagamento_tipo.length() > 0) {            sql = "";            if (documento_tipo.equals(Db.TIPO_DOCUMENTO_DDT)) {                sql = "Select * from test_ddt";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                sql = "Select * from test_fatt";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA_RICEVUTA)) {                sql = "Select * from test_fatt_acquisto";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE)) {                sql = "Select * from test_ordi";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE_ACQUISTO)) {                sql = "Select * from test_ordi_acquisto";            }            sql += " where serie = " + Db.pc(documento_serie, Types.VARCHAR);            sql += " and numero = " + Db.pc(documento_numero, Types.INTEGER);            sql += " and anno = " + Db.pc(documento_anno, Types.INTEGER);            if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                sql += " and IFNULL(tipo_fattura,0) != 7";            }            System.out.println("sql importo scadenze = " + sql);            ResultSet tempDocu = Db.openResultSet(conn, sql);            try {                tempDocu.next();                if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA_RICEVUTA)) {                    documento_importo = tempDocu.getDouble("importo");                    documento_imponibile = tempDocu.getDouble("imponibile");                    documento_iva = tempDocu.getDouble("iva");                    try {                        if (tempDocu.getDouble("totale_da_pagare") > 0) {                            this.documento_importo = tempDocu.getDouble("totale_da_pagare");                        }                    } catch (Exception e) {                        e.printStackTrace();                    }                } else {                    documento_importo = tempDocu.getDouble("totale");                    documento_imponibile = tempDocu.getDouble("totale_imponibile");                    documento_iva = tempDocu.getDouble("totale_iva");                    if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                        if (tempDocu.getDouble("totale_da_pagare") > 0) {                            this.documento_importo = tempDocu.getDouble("totale_da_pagare");                        }                    }                }            } catch (Exception err) {                err.printStackTrace();                System.out.println("sql:" + sql);            }            sql = "Select * from scadenze";            sql += " where documento_tipo = " + Db.pc(documento_tipo, Types.VARCHAR);            sql += " and documento_serie = " + Db.pc(documento_serie, Types.VARCHAR);            sql += " and documento_numero = " + Db.pc(documento_numero, Types.INTEGER);            sql += " and documento_anno = " + Db.pc(documento_anno, Types.INTEGER);            ResultSet tempScad = Db.openResultSet(conn, sql);            //controllo se ci sono gi??? scadenze altrimenti le provo a generare            try {                if (tempScad.next()) {                    // c'??? almeno una scadenza, allora niente                } else {                    //non ci sono scadenze, chiedo se si vogliono generare                    //int ret = javax.swing.JOptionPane.showConfirmDialog(null, "Non ci sono scadenze, generarle automaticamente in base al tipo di pagamento?","Attenzione",javax.swing.JOptionPane.YES_NO_OPTION,javax.swing.JOptionPane.QUESTION_MESSAGE);                    //if (ret == javax.swing.JOptionPane.YES_OPTION) {                    //generazione scadenze                    generaScadenze(conn);                    //}                }            } catch (Exception err) {                err.printStackTrace();            }        }    }    public boolean totaliDiversi() {        System.err.println("documento_importo = " + documento_importo);        String sql = "Select sum(importo) as tot from scadenze";        sql += " where documento_tipo = " + Db.pc(documento_tipo, Types.VARCHAR);        sql += " and documento_serie = " + Db.pc(documento_serie, Types.VARCHAR);        sql += " and documento_numero = " + Db.pc(documento_numero, Types.INTEGER);        sql += " and documento_anno = " + Db.pc(documento_anno, Types.INTEGER);        ResultSet tempScad = null;        totale_scadenze = 0;        try {            tempScad = DbUtils.tryOpenResultSet(Db.getConn(), sql);            if (tempScad.next()) {                totale_scadenze = tempScad.getDouble(1);                System.err.println("totale_scadenze = " + totale_scadenze);            }        } catch (Exception e) {            e.printStackTrace();        } finally {            try {                tempScad.close();            } catch (Exception e) {            }        }        double totale_doc_2d = FormatUtils.round(documento_importo, 2);        System.err.println("totale_doc_2d = " + totale_doc_2d);        double totale_sca_2d = FormatUtils.round(totale_scadenze, 2);        System.err.println("totale_sca_2d = " + totale_sca_2d);        if (totale_doc_2d != totale_sca_2d) {            return true;        } else {            return false;        }    }    public void generaProvvigioni() {        generaProvvigioni(null, null, null, null, null, null, null);    }    public void generaProvvigioni(Date oldDataScadenza, Date nuovaDataScadenza, Double oldImporto, Double nuovoImporto, Boolean genera_solo_se_necessario, String oldStato, String newStato) {        boolean continuare = true;        if (genera_solo_se_necessario != null && genera_solo_se_necessario) {            if (oldDataScadenza.equals(nuovaDataScadenza) && nuovoImporto.equals(oldImporto)) {                System.out.println("non genero le provvigioni perchè non necessario: " + oldDataScadenza + "=" + nuovaDataScadenza + " e " + oldImporto + "=" + nuovoImporto);                //controllo se era pagata ed è stata messa come non pagata o parzialmente pagata e c'era una provvigione pagata avverto                if (oldStato != null && newStato != null && oldStato.equals("S") && (newStato.equals("P") || newStato.equals("N"))) {                    String sql = "select * from provvigioni";                    sql += " where documento_tipo = " + Db.pc(this.documento_tipo, Types.VARCHAR);                    sql += " and documento_serie = " + Db.pc(this.documento_serie, Types.VARCHAR);                    sql += " and documento_numero = " + Db.pc(this.documento_numero, Types.INTEGER);                    sql += " and documento_anno = " + Db.pc(this.documento_anno, Types.INTEGER);                    sql += " and data_scadenza = " + Db.pc(nuovaDataScadenza, Types.DATE);                    sql += " and pagata = 'S'";                    String newStatoDescr = "";                    if (newStato.equals("P")) newStatoDescr = "Pagata parzialmente";                    if (newStato.equals("N")) newStatoDescr = "NON Pagata";                    try {                        if (DbUtils.containRows(Db.getConn(), sql)) {                            SwingUtils.showInfoMessage(main.getPadre(), "Attenzione hai messo come '" + newStatoDescr + "' una scadenza per la quale la provvigione è segnata come pagata !");                        }                    } catch (Exception e) {                        e.printStackTrace();                    }                }                continuare = false;            }        }        if (continuare) {            try {                String dbSerie = documento_serie;                int dbNumero = documento_numero;                int dbAnno = documento_anno;                Integer dbIdFattura = null;                if (documento_tipo.equals(Db.TIPO_DOCUMENTO_DDT)) {                    dbIdFattura = InvoicexUtil.getIdDdt(dbSerie, dbNumero, dbAnno);                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                    dbIdFattura = InvoicexUtil.getIdFattura(dbSerie, dbNumero, dbAnno);                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA_RICEVUTA)) {                    dbIdFattura = InvoicexUtil.getIdFatturaAcquisto(dbSerie, dbNumero, dbAnno);                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE)) {                    dbIdFattura = InvoicexUtil.getIdOrdine(dbSerie, dbNumero, dbAnno);                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE_ACQUISTO)) {                    dbIdFattura = InvoicexUtil.getIdOrdineAcquisto(dbSerie, dbNumero, dbAnno);                }                String tab = "";                if (documento_tipo.equals(Db.TIPO_DOCUMENTO_DDT)) {                    tab = "test_ddt";                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                    tab = "test_fatt";                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA_RICEVUTA)) {                    tab = "test_fatt_acquisto";                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE)) {                    tab = "test_ordi";                } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE_ACQUISTO)) {                    tab = "test_ordi_acquisto";                }                int agente_codice = CastUtils.toInteger(DbUtils.getObject(Db.getConn(), "select agente_codice from " + tab + " where id = " + dbIdFattura));                double agente_perc = CastUtils.toDouble(DbUtils.getObject(Db.getConn(), "select agente_percentuale from " + tab + " where id = " + dbIdFattura));                ProvvigioniFattura provvigioni = new ProvvigioniFattura(documento_tipo, dbSerie, dbNumero, dbAnno, agente_codice, agente_perc);                double nuovoImportoTeoricoProvvigioni = provvigioni.getTotaleProvvigioni();                boolean ret = provvigioni.generaProvvigioni();                System.out.println("esito genera provvigioni da scadenze:" + ret + " : " + provvigioni.ret);            } catch (Exception e) {                e.printStackTrace();            }        }    }    public boolean generaScadenze() {        return generaScadenze(null);    }        public boolean generaScadenze(Connection conn) {        String sql;        this.numero = 0;        //seleziono numero ultimo +1;        java.sql.Statement stat;        ResultSet resu;        Byte giornoMese = null;        sql = "";        if (pagamento_tipo == null) {            if (documento_tipo.equals(Db.TIPO_DOCUMENTO_DDT)) {                sql = "Select pagamento from test_ddt";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                sql = "Select pagamento from test_fatt";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA_RICEVUTA)) {                sql = "Select pagamento from test_fatt_acquisto";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE)) {                sql = "Select pagamento from test_ordi";            } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE_ACQUISTO)) {                sql = "Select pagamento from test_ordi_acquisto";            }            sql += " where serie = " + Db.pc(documento_serie, Types.VARCHAR);            sql += " and numero = " + Db.pc(documento_numero, Types.INTEGER);            sql += " and anno = " + Db.pc(documento_anno, Types.INTEGER);            if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {                sql += " and IFNULL(tipo_fattura,0) != 7";            }            ResultSet tempDocuPagamento = Db.openResultSet(conn, sql);            try {                tempDocuPagamento.next();                pagamento_tipo = tempDocuPagamento.getString(1);            } catch (Exception err) {                err.printStackTrace();            }        }        if (pagamento_tipo == null) {            SwingUtils.showErrorMessage(main.getPadre(), "Scadenze di pagamento non generate perchè vuoto il tipo di pagamento");            return false;        }        sql = "select * from pagamenti";        sql += " where codice = " + Db.pc(this.pagamento_tipo, Types.VARCHAR);        ResultSet tempPaga = Db.openResultSet(conn, sql);        try {            if (tempPaga.next()) {                //mi memorizzo se flaggare come gia' pagate no                if (Db.nz(tempPaga.getString("flag_pagata"), "").equalsIgnoreCase("S")) {                    this.flag_pagata = true;                } else {                    this.flag_pagata = false;                }                //controllo che non ci siano scadenze gia' stampate in distinta                if (conn != null) {                    stat = conn.createStatement();                } else {                    stat = Db.getConn().createStatement();                }                sql = "select id, data_scadenza, importo, distinta from scadenze";                sql += " where documento_tipo = " + Db.pc(this.documento_tipo, Types.VARCHAR);                sql += " and documento_serie = " + Db.pc(this.documento_serie, Types.VARCHAR);                sql += " and documento_numero = " + Db.pc(this.documento_numero, Types.INTEGER);                sql += " and documento_anno = " + Db.pc(this.documento_anno, Types.INTEGER);                sql += " and distinta is not null";                resu = stat.executeQuery(sql);                if (resu.next() == true) {                    //storico                    Storico.scrivi("Genera Scadenze Controllo", "Documento = " + documento_tipo + "/" + documento_serie + "/" + documento_numero + "/" + documento_anno + ", Pagamento = " + pagamento_tipo + ", Importo documento = " + documento_importo + " CI SONO DELLE SCADENZE GIA IN DISTINTA!!!");                    try {                        resu.previous();                        String msg = "Le seguenti scadenze sono gia' state incluse nella distinta per la banca:";                        while (resu.next()) {                            msg += "\n" + resu.getString("id") + " al " + dateFormat.format(resu.getDate("data_scadenza")) + " di " + "\u20AC" + it.tnx.Db.formatValuta(resu.getDouble("importo")) + " distinta " + resu.getString("distinta");                        }                        msg += "\nSicuro di continuare e rigenerarle ?";                        int ret = javax.swing.JOptionPane.showConfirmDialog(null, msg, "Attenzione", javax.swing.JOptionPane.YES_NO_OPTION);                        if (ret == javax.swing.JOptionPane.NO_OPTION) {                            return false;                        }                    } catch (Exception err) {                        err.printStackTrace();                    }                }                //elimino le pecedenti scadenze                sql = "delete from scadenze";                sql += " where documento_tipo = " + Db.pc(this.documento_tipo, Types.VARCHAR);                sql += " and documento_serie = " + Db.pc(this.documento_serie, Types.VARCHAR);                sql += " and documento_numero = " + Db.pc(this.documento_numero, Types.INTEGER);                sql += " and documento_anno = " + Db.pc(this.documento_anno, Types.INTEGER);                //sql += " and distinta is null";                Db.executeSql(conn, sql);                //apre il resultset per ultimo +1                try {                    if (conn != null) {                        stat = conn.createStatement();                    } else {                        stat = Db.getConn().createStatement();                    }                    sql = "select numero from scadenze";                    sql += " where documento_tipo = " + Db.pc(this.documento_tipo, Types.VARCHAR);                    sql += " and documento_serie = " + Db.pc(this.documento_serie, Types.VARCHAR);                    sql += " and documento_numero = " + Db.pc(this.documento_numero, Types.INTEGER);                    sql += " and documento_anno = " + Db.pc(this.documento_anno, Types.INTEGER);                    sql += " order by numero desc limit 1";                    resu = stat.executeQuery(sql);                    if (resu.next() == true) {                        this.numero = (resu.getInt(1) + 1);                    } else {                        this.numero = 1;                    }                } catch (Exception err) {                    javax.swing.JOptionPane.showMessageDialog(null, err.toString());                }                if (documento_data == null) {                    documento_data = getResultSetDocumento().getDate("data");                }                //trovato il tipo di pagamento//                if ("S".equalsIgnoreCase(tempPaga.getString("IMMEDIATO"))) {////                    //genero una sola scadenza dato che il pagamento ??? di tipo IMMEDAITO//                    inserisciScadenza(this.documento_importo, documento_data);////                    //storico//                    Storico.scrivi("Genera Scadenze Immediato", "Documento = " + documento_serie + "/" + documento_numero + "/" + documento_anno + ", Pagamento = " + pagamento_tipo + ", Importo documento = " + documento_importo);////                    //msg di conferma//                    //javax.swing.JOptionPane.showMessageDialog(null, "scadenze generate");//                } else {                //genero alle scadenze prefissate a partire dalla data del docuemnto                //prendo data documento                ResultSet tempDocu;                tempDocu = getResultSetDocumento();                java.util.Date dataInizio;                java.util.Calendar tempCale;                dataInizio = documento_data;                tempCale = java.util.GregorianCalendar.getInstance();                //conto quante scadenze e divido l'importo                int contaScadenze = 0;                if ("S".equalsIgnoreCase(tempPaga.getString("IMMEDIATO"))) {                    contaScadenze++;                }                if (tempPaga.getString("15").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("30").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("45").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("60").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("75").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("90").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("120").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("150").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("180").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("210").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("240").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("270").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("300").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("330").equalsIgnoreCase("S")) {                    contaScadenze++;                }                if (tempPaga.getString("360").equalsIgnoreCase("S")) {                    contaScadenze++;                }                boolean iva30gg = false;                if (CastUtils.toString(tempPaga.getString("iva30gg")).equalsIgnoreCase("S")) {                    iva30gg = true;                }                double importoScadenza = this.documento_importo / contaScadenze;                if (iva30gg) {//                    importoScadenza = this.documento_imponibile / contaScadenze;                    //se presente rivalsa l'iva devo calcolare l'importo da pagare e non l'imponibile                    importoScadenza = (this.documento_importo - this.documento_iva) / contaScadenze;                }                //calcolo scarto da aggiungere alla prima scadenza                //java.math.BigDecimal bdImportoScadenza = new java.math.BigDecimal(importoScadenza);                //bdImportoScadenza = bdImportoScadenza.setScale(2, java.math.BigDecimal.ROUND_HALF_UP);                //quadratura = this.documento_importo - (bdImportoScadenza.doubleValue() * contaScadenze);                double importoScadenzaApprossimato = it.tnx.Util.round(importoScadenza, 2);                if (iva30gg) {//                    quadratura = it.tnx.Util.round(this.documento_imponibile - (importoScadenzaApprossimato * contaScadenze), 2);                    //se presente rivalsa l'iva devo calcolare l'importo da pagare e non l'imponibile                    quadratura = it.tnx.Util.round((this.documento_importo - this.documento_iva) - (importoScadenzaApprossimato * contaScadenze), 2);                } else {                    quadratura = it.tnx.Util.round(this.documento_importo - (importoScadenzaApprossimato * contaScadenze), 2);                }                //storico                Storico.scrivi(conn, "Genera Scadenze Varie", "Documento = " + documento_tipo + "/" + documento_serie + "/" + documento_numero + "/" + documento_anno + ", Pagamento = " + pagamento_tipo + ", Importo scaenza = " + String.valueOf(importoScadenzaApprossimato) + ", Importo documento = " + documento_importo + ", Scadenze = " + contaScadenze + ", Data = " + documento_data);                boolean fineMese;                if (tempPaga.getString("FINEMESE").equalsIgnoreCase("S")) {                    fineMese = true;                } else {                    fineMese = false;                }                boolean specificaGiorno = false;                if (tempPaga.getString("flag_richiedi_giorno").equalsIgnoreCase("S")) {                    specificaGiorno = true;                    giornoMese = new Byte(tempDocu.getByte("giorno_pagamento"));                } else {                    giornoMese = null;                }                //imm                if ("S".equalsIgnoreCase(tempPaga.getString("IMMEDIATO"))) {                    tempCale = calcolaData(dataInizio, 0, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //15                 if (tempPaga.getString("15").equalsIgnoreCase("S")) {// 45 == 97                    tempCale = calcolaData(dataInizio, 97, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //30                if (tempPaga.getString("30").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 1, fineMese, giornoMese);                    //iva30gg                    if (iva30gg) {                        inserisciScadenza(conn, importoScadenza + documento_iva, tempCale.getTime());                    } else {                        inserisciScadenza(conn, importoScadenza, tempCale.getTime());                    }                }                //iva30gg                if (iva30gg && !tempPaga.getString("30").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 1, fineMese, giornoMese);                    inserisciScadenza(conn, documento_iva, tempCale.getTime());                }                //45                if (tempPaga.getString("45").equalsIgnoreCase("S")) {// 45 == 99                    tempCale = calcolaData(dataInizio, 99, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //60                if (tempPaga.getString("60").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 2, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //75                if (tempPaga.getString("75").equalsIgnoreCase("S")) {// 75 == 98                    tempCale = calcolaData(dataInizio, 98, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //90                if (tempPaga.getString("90").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 3, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //120                if (tempPaga.getString("120").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 4, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //150                if (tempPaga.getString("150").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 5, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //180                if (tempPaga.getString("180").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 6, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //210                if (tempPaga.getString("210").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 7, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //240                if (tempPaga.getString("240").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 8, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //270                if (tempPaga.getString("270").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 9, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //300                if (tempPaga.getString("300").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 10, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //330                if (tempPaga.getString("330").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 11, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }                //360                if (tempPaga.getString("360").equalsIgnoreCase("S")) {                    tempCale = calcolaData(dataInizio, 12, fineMese, giornoMese);                    inserisciScadenza(conn, importoScadenza, tempCale.getTime());                }//                }                return true;            } else {                javax.swing.JOptionPane.showMessageDialog(null, "Impossibile trovare il tipo di pagamento");                //storico                Storico.scrivi("Genera Scadenze Errore Pagamento", "Documento = " + documento_tipo + "/" + documento_serie + "/" + documento_numero + "/" + documento_anno + ", Pagamento = " + pagamento_tipo + ", Importo documento = " + documento_importo);                return false;            }        } catch (Exception err) {            err.printStackTrace();            return false;        }    }    static public GregorianCalendar calcolaData(java.util.Date dataInizio, int mesi, boolean fineMese) {        return (calcolaData(dataInizio, mesi, fineMese, null));    }    static public GregorianCalendar calcolaData(java.util.Date dataInizio, int mesi, boolean fineMese, Byte giornoMese) {        Calendar tempCale = GregorianCalendar.getInstance();        tempCale.setTime(dataInizio);                System.out.println("\nmesi = "+mesi+" - giornoMese = "+giornoMese+" - fineMese = "+fineMese);                    if (fineMese == false && giornoMese == null) {            //calcolo a giorni commerciali            System.out.println("22-PRIMA tempCale = "+((GregorianCalendar) tempCale).getTime());                        if (mesi == 99) { //45                tempCale.add(java.util.Calendar.MONTH, 1);                tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);            } else if (mesi == 98) { //75                tempCale.add(java.util.Calendar.MONTH, 2);                tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);            } else if (mesi == 97) { //15                tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                       } else { //other                tempCale.add(java.util.Calendar.MONTH, mesi);                        }        } else if (giornoMese != null) {                                    //calcolo al giorno specificato            //controllo che il giorno della fattura sia inferiore al giorno del pagamento altrimenti devo aggiungere piu' giorni            if (fineMese) {                tempCale.set(tempCale.DAY_OF_MONTH, giornoMese.byteValue());                if (mesi == 99) { //45                        tempCale.add(java.util.Calendar.MONTH, 2);                        tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                        } else if (mesi == 98) { //75                            tempCale.add(java.util.Calendar.MONTH, 3);                            tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                            } else if (mesi == 97) { //15                                tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                                        } else { //other                                tempCale.add(java.util.Calendar.MONTH, mesi +1);                                        }                            int giorniMese = tempCale.getActualMaximum(tempCale.DAY_OF_MONTH);            tempCale.set(tempCale.DAY_OF_MONTH, giorniMese);            } else {                if (tempCale.get(tempCale.DAY_OF_MONTH) > giornoMese.byteValue()) {                    tempCale.set(tempCale.DAY_OF_MONTH, giornoMese.byteValue());                                       if (mesi == 99) { //45                        tempCale.add(java.util.Calendar.MONTH, 2);                        tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                        } else if (mesi == 98) { //75                            tempCale.add(java.util.Calendar.MONTH, 3);                            tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                            } else if (mesi == 97) { //15                            tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                                        }  else { //other                                tempCale.add(java.util.Calendar.MONTH, mesi +1);                                        }                       } else {                    tempCale.set(tempCale.DAY_OF_MONTH, giornoMese.byteValue());                    if (mesi == 99) { //45                        tempCale.add(java.util.Calendar.MONTH, 1);                        tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                    } else if (mesi == 98) { //75                        tempCale.add(java.util.Calendar.MONTH, 2);                        tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                    } else if (mesi == 97) { //15                            tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);                                } else { //other                        tempCale.add(java.util.Calendar.MONTH, mesi);                                }                }            }        } else {            //calcolo a fine mese            //System.out.println("Days in this month " + calendar.getActualMaximum(Calendar.DAY_OF_MONTH));            //controllo se generare nel mese corrente o quello standard successivo                        System.out.println("33-PRIMA tempCale = "+((GregorianCalendar) tempCale).getTime());            if (mesi == 99) { //45                tempCale.add(java.util.Calendar.MONTH, 1);                tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);            } else if (mesi == 98) { //75                tempCale.add(java.util.Calendar.MONTH, 2);                tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);            } else if (mesi == 97) { //15                tempCale.add(java.util.Calendar.DAY_OF_MONTH, 15);            } else {                tempCale.add(java.util.Calendar.MONTH, mesi);                        }                     int giorniMese = tempCale.getActualMaximum(tempCale.DAY_OF_MONTH);            tempCale.set(tempCale.DAY_OF_MONTH, giorniMese);                        System.out.println("33-DOPO tempCale = "+((GregorianCalendar) tempCale).getTime());        }        return (GregorianCalendar) tempCale;    }    private void inserisciScadenza(double importo, java.util.Date scadenza) {        inserisciScadenza(null, importo, scadenza);    }        private void inserisciScadenza(Connection conn, double importo, java.util.Date scadenza) {        //per la quadratura aggiungo alla prima scadenza l'importo della quadratura        importo = it.tnx.Util.round(importo + quadratura, 2);        quadratura = 0;        String sql = "";        try {            //genero una sola scadenza dato che il pagamento ??? di tipo IMMEDAITO            sql = "insert into scadenze (documento_tipo";            sql += ",documento_serie";            sql += ",documento_numero";            sql += ",documento_anno";            sql += ",data_scadenza";            sql += ",pagata";            sql += ",importo";            sql += ",numero) values (";            //valori            sql += Db.pc(this.documento_tipo, Types.VARCHAR);            sql += "," + Db.pc(this.documento_serie, Types.VARCHAR);            sql += "," + Db.pc(this.documento_numero, Types.INTEGER);            sql += "," + Db.pc(this.documento_anno, Types.INTEGER);            //sql += "," + Db.pc(Db.formatDataMysql(java.util.Calendar.getInstance().getTime()), Types.DATE);            sql += "," + Db.pc(Db.formatDataMysql(scadenza), Types.DATE);            //sql += "," + Db.pc("N", Types.VARCHAR);            //metto come defautl a pagata S, se arrivano insoluti si vanno ad inserire            if (this.flag_pagata == true) {                sql += "," + Db.pc("S", Types.VARCHAR);            } else {                sql += "," + Db.pc("N", Types.VARCHAR);            }            sql += "," + Db.pc(importo, Types.DOUBLE);            sql += "," + Db.pc(this.numero, Types.INTEGER);            sql += ")";            //storico            Storico.scrivi(conn, "Genera Scadenze Inserisci", "Documento = " + documento_tipo + "/" + documento_serie + "/" + documento_numero + "/" + documento_anno + ", Importo = " + importo + ", Numero = " + numero + ", Data = " + scadenza);                       Db.executeSql(conn, sql);            this.numero++;        } catch (Exception err) {            err.printStackTrace();        }    }    ResultSet getResultSetDocumento() {        String sql = "";        if (documento_tipo.equals(Db.TIPO_DOCUMENTO_DDT)) {            sql = "Select * from test_ddt";        } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {            sql = "Select * from test_fatt";        } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA_RICEVUTA)) {            sql = "Select * from test_fatt_acquisto";        } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE)) {            sql = "Select * from test_ordi";        } else if (documento_tipo.equals(Db.TIPO_DOCUMENTO_ORDINE_ACQUISTO)) {            sql = "Select * from test_ordi_acquisto";        }        sql += " where serie = " + Db.pc(documento_serie, Types.VARCHAR);        sql += " and numero = " + Db.pc(documento_numero, Types.INTEGER);        sql += " and anno = " + Db.pc(documento_anno, Types.INTEGER);        if (documento_tipo.equals(Db.TIPO_DOCUMENTO_FATTURA)) {            sql += " and IFNULL(tipo_fattura,0) != 7";        }        ResultSet tempDocu = Db.openResultSet(conn, sql);        try {            tempDocu.next();        } catch (Exception err) {            err.printStackTrace();        }        return tempDocu;    }    public static boolean controllaTotali(String sql, JInternalFrame frame) {        try {            Vector fattureDiverse = new Vector();            Vector fattureDiverseSerie = new Vector();            Vector fattureDiverseAnno = new Vector();            Vector fattureDiverseNumero = new Vector();            ResultSet temp = Db.openResultSet(sql);            String oldKey = "-1";            String currentKey = "";            String currentKeySerie = "";            String currentKeyAnno = "";            String currentKeyNumero = "";            double totaleFattura = 0;            double totaleScadenze = 0;            String serie;            int numero;            int anno;            while (temp.next()) {                currentKey = temp.getString("test_fatt.numero");                currentKeySerie = temp.getString("test_fatt.serie");                currentKeyAnno = temp.getString("test_fatt.anno");                currentKeyNumero = temp.getString("test_fatt.numero");                if (oldKey.equalsIgnoreCase(currentKey) || oldKey.equals("-1")) {                    //sommo                    totaleFattura = temp.getDouble("test_fatt.totale");                    totaleScadenze += temp.getDouble("scadenze.importo");                } else {                    if (totaleFattura != totaleScadenze) {                        fattureDiverse.add(currentKey);                        fattureDiverseSerie.add(currentKeySerie);                        fattureDiverseAnno.add(currentKeyAnno);                        fattureDiverseNumero.add(currentKeyNumero);                    }                    //azzero                    totaleFattura = 0;                    totaleScadenze = 0;                }                oldKey = temp.getString("test_fatt.numero");            }            if (fattureDiverse.size() > 0) {                javax.swing.JOptionPane.showMessageDialog(null, "Ci sono delle scadenze non congruenti con le fatture :" + fattureDiverse.toString());                for (int i = 0; i < fattureDiverse.size(); i++) {                    serie = fattureDiverseSerie.get(i).toString();                    numero = Integer.parseInt(fattureDiverseNumero.get(i).toString());                    anno = Integer.parseInt(fattureDiverseAnno.get(i).toString());                    Scadenze tempScad = new Scadenze(Db.TIPO_DOCUMENTO_FATTURA, serie, numero, anno, null);                    frmPagaPart frm = new frmPagaPart(tempScad, null);                    main.getPadre().openFrame(frm, 450, 400, 200 + (i * 10), 100 + (i * 10));                }                return false;            }            return true;        } catch (Exception err) {            err.printStackTrace();            return false;        }    }}